version: '3.8'

services:
  kestra:
    image: kestra/kestra:v1.1.6
    container_name: kestra
    command: server standalone
    ports:
      - "8082:8080"
    env_file:
      - ./.env                  # Load KESTRA_DB_* and API keys
      - ./apps/web/.env.local   # Load Supabase public keys
    pull_policy: always
    environment:
      KESTRA_CONFIGURATION: |
        kestra:
          variables:
            env-vars-prefix: "APP_"
          server:
            basic-auth:
              username: admin@kestra.local
              password: Admin123456
          repository:
            type: postgres
          queue:
            type: postgres
          storage:
            type: local
            local:
              base-path: /app/storage
        datasources:
          postgres:
            url: jdbc:postgresql://${KESTRA_DB_HOST}:${KESTRA_DB_PORT}/${KESTRA_DB_NAME}?currentSchema=kestra
            driverClassName: org.postgresql.Driver
            username: ${KESTRA_DB_USER}
            password: ${KESTRA_DB_PASSWORD}
      APP_GEMINI_API_KEY: ${GEMINI_API_KEY}
      APP_VAPI_API_KEY: ${VAPI_API_KEY}
      APP_VAPI_PHONE_NUMBER_ID: ${VAPI_PHONE_NUMBER_ID}

    volumes:
      - ./kestra/flows:/app/flows
      - ./kestra/scripts:/kestra
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - kestra-net
    restart: always

networks:
  kestra-net:
    driver: bridge
