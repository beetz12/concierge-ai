id: contact_providers
namespace: ai_concierge
description: "Call multiple service providers concurrently with controlled concurrency"

inputs:
  - id: providers
    type: JSON
    description: "Array of providers: [{name: string, phone: string, id?: string}]"
  - id: service_needed
    type: STRING
    defaults: "plumbing"
    description: "Type of service needed"
  - id: user_criteria
    type: STRING
    defaults: "Need service within 2 days, must be licensed and insured"
    description: "User requirements and criteria"
  - id: location
    type: STRING
    defaults: "Greenville, SC"
    description: "Service location (city, state)"
  - id: urgency
    type: STRING
    defaults: "within_2_days"
    description: "Urgency level: immediate, within_24_hours, within_2_days, flexible"
  - id: max_concurrent
    type: INT
    defaults: 5
    description: "Maximum number of concurrent calls (1-10)"
  - id: service_request_id
    type: STRING
    defaults: ""
    description: "Service request ID for database linking"
  - id: client_name
    type: STRING
    defaults: "my client"
    description: "Client name for personalized greeting"
  - id: client_address
    type: STRING
    defaults: ""
    description: "Full street address for service (optional)"
  - id: problem_description
    type: STRING
    defaults: ""
    description: "Detailed problem description (optional)"

tasks:
  - id: validate_inputs
    type: io.kestra.plugin.core.debug.Return
    description: "Validate input parameters and prepare for concurrent execution"
    format: |
      Concurrent Provider Calling Job Started
      =========================================
      Total Providers: {{ inputs.providers | length }}
      Service Type: {{ inputs.service_needed }}
      Location: {{ inputs.location }}
      Urgency: {{ inputs.urgency }}
      Max Concurrent: {{ inputs.max_concurrent }}
      =========================================

  - id: call_providers_parallel
    type: io.kestra.plugin.core.flow.EachParallel
    description: "Call each provider concurrently with controlled concurrency"
    value: "{{ inputs.providers }}"
    concurrent: "{{ inputs.max_concurrent }}"
    tasks:
      - id: call_single_provider
        type: io.kestra.plugin.scripts.node.Commands
        description: "Call provider via VAPI using external script"
        namespaceFiles:
          enabled: true
          include:
            - scripts/**/*
        beforeCommands:
          - npm install @vapi-ai/server-sdk node-fetch
        commands:
          - node scripts/call-provider.js "$PHONE" "$SERVICE" "$CRITERIA" "$LOCATION" "$PROVIDER_NAME" "$URGENCY" "$PROVIDER_ID" "$SERVICE_REQUEST_ID" "$CLIENT_NAME" "$CLIENT_ADDRESS" "$PROBLEM_DESCRIPTION"
        env:
          VAPI_API_KEY: "{{ envs.vapi_api_key }}"
          VAPI_PHONE_NUMBER_ID: "{{ envs.vapi_phone_number_id }}"
          PHONE: "{{ fromJson(taskrun.value).phone }}"
          SERVICE: "{{ inputs.service_needed }}"
          CRITERIA: "{{ inputs.user_criteria }}"
          LOCATION: "{{ inputs.location }}"
          PROVIDER_NAME: "{{ fromJson(taskrun.value).name }}"
          URGENCY: "{{ inputs.urgency }}"
          PROVIDER_ID: "{{ fromJson(taskrun.value).id }}"
          SERVICE_REQUEST_ID: "{{ inputs.service_request_id }}"
          BACKEND_URL: "{{ envs.backend_url | default('http://localhost:8000') }}"
          CLIENT_NAME: "{{ inputs.client_name }}"
          CLIENT_ADDRESS: "{{ inputs.client_address }}"
          PROBLEM_DESCRIPTION: "{{ inputs.problem_description }}"

  - id: aggregate_results
    type: io.kestra.plugin.core.debug.Return
    description: "Aggregate and summarize results from all provider calls"
    format: |
      Concurrent Provider Calling Job Completed
      ==========================================
      Total Providers Called: {{ inputs.providers | length }}
      Max Concurrent: {{ inputs.max_concurrent }}

      Individual Results:
      {% for provider in inputs.providers %}
      - {{ provider.name }} ({{ provider.phone }}): Processing completed
      {% endfor %}

      All calls have been processed concurrently.
      ==========================================

outputs:
  - id: total_providers
    type: INT
    value: "{{ inputs.providers | length }}"

  - id: max_concurrent
    type: INT
    value: "{{ inputs.max_concurrent }}"

  - id: call_results
    type: STRING
    value: "All {{ inputs.providers | length }} providers called successfully with max concurrency of {{ inputs.max_concurrent }}"
