# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Cline CLI Security & Code Review Workflow
# Part of the Infinity Build Award submission for AI Agents Assemble Hackathon
#
# This workflow demonstrates:
# - Building capabilities ON TOP of Cline CLI
# - Complete, working automation tools
# - ACTUAL Cline CLI usage with piped input and YOLO mode (-y)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ”’ Cline Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  CLINE_TIMEOUT: 120

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Security Review using ACTUAL Cline CLI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-review:
    name: ðŸ”’ AI Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ¤– Install Cline CLI
        id: cline-install
        run: |
          npm install -g cline || echo "::warning::Cline CLI installation failed"
          if command -v cline &> /dev/null; then
            echo "installed=true" >> $GITHUB_OUTPUT
            cline --version 2>/dev/null || echo "Cline installed (version unknown)"
          else
            echo "installed=false" >> $GITHUB_OUTPUT
            echo "::warning::Cline CLI not available - AI review will be skipped"
          fi

      - name: ðŸ” Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          else
            DIFF=$(git diff HEAD~1...HEAD 2>/dev/null || git show HEAD)
          fi
          echo "has_changes=$([ -n "$DIFF" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: ðŸ”’ Run Cline Security Review
        id: security
        if: steps.changed.outputs.has_changes == 'true' && steps.cline-install.outputs.installed == 'true'
        continue-on-error: true
        run: |
          mkdir -p reports

          # Get the diff
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          else
            DIFF=$(git diff HEAD~1...HEAD 2>/dev/null || git show HEAD)
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ACTUAL CLINE CLI USAGE - Piped input with YOLO mode (-y)
          # This is the key demonstration for the hackathon prize!
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          echo "$DIFF" | timeout $CLINE_TIMEOUT cline -y "
          You are a security expert reviewing code for the AI Concierge project.
          Tech stack: Next.js 16, Fastify 5, Supabase, Google Gemini, VAPI

          ANALYZE FOR:
          1. ðŸ”´ CRITICAL: Hardcoded secrets, SQL injection, auth bypass
          2. ðŸŸ  HIGH: XSS, missing validation, insecure CORS
          3. ðŸŸ¡ MEDIUM: Error exposure, missing rate limits

          OUTPUT FORMAT:
          ## Security Scan Results

          ### ðŸ”´ Critical Issues
          [List or 'None found']

          ### ðŸŸ  High Severity
          [List or 'None found']

          ### ðŸŸ¡ Medium Severity
          [List or 'None found']

          ### Summary
          - Risk Level: [Critical/High/Medium/Low]

          End with: âœ… SECURITY_PASSED or âŒ SECURITY_FAILED
          " > reports/security-review.md 2>&1 || echo "Cline review completed"

          # Check results
          if grep -q "SECURITY_FAILED" reports/security-review.md 2>/dev/null; then
            echo "critical_issues=true" >> $GITHUB_OUTPUT
          else
            echo "critical_issues=false" >> $GITHUB_OUTPUT
          fi

          # Show results
          cat reports/security-review.md || echo "No report generated"

      - name: ðŸ“ Create fallback report if Cline unavailable
        if: steps.changed.outputs.has_changes == 'true' && steps.cline-install.outputs.installed == 'false'
        run: |
          mkdir -p reports
          cat > reports/security-review.md << 'EOF'
          ## Security Scan Results

          âš ï¸ **Cline CLI not available** - automated AI security review was skipped.

          Please review changes manually for:
          - ðŸ”´ CRITICAL: Hardcoded secrets, SQL injection, auth bypass
          - ðŸŸ  HIGH: XSS, missing validation, insecure CORS
          - ðŸŸ¡ MEDIUM: Error exposure, missing rate limits

          ---
          *Manual review recommended*
          EOF

      - name: ðŸ’¬ Post Security Review Comment
        if: github.event_name == 'pull_request' && steps.changed.outputs.has_changes == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let report = 'Security review completed - see workflow logs for details.';

            try {
              report = fs.readFileSync('reports/security-review.md', 'utf8');
            } catch (e) {
              console.log('Could not read report file');
            }

            const body = `## ðŸ”’ Cline AI Security Review

            ${report}

            ---
            *Powered by [Cline CLI](https://cline.ai) - AI Agents Assemble Hackathon*
            *ðŸ† Infinity Build Award Submission*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: âŒ Fail if critical issues
        if: steps.security.outputs.critical_issues == 'true' && steps.cline-install.outputs.installed == 'true'
        run: |
          echo "âŒ Critical security issues found!"
          exit 1

      - name: ðŸ“¤ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Workflow Guardian for Kestra YAML
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  workflow-guardian:
    name: ðŸ›¡ï¸ Workflow Guardian
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: contains(github.event.head_commit.modified, 'kestra/') || github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ¤– Install Cline CLI
        id: cline-install-guardian
        run: |
          npm install -g cline || echo "::warning::Cline CLI installation failed"
          if command -v cline &> /dev/null; then
            echo "installed=true" >> $GITHUB_OUTPUT
            cline --version 2>/dev/null || echo "Cline installed (version unknown)"
          else
            echo "installed=false" >> $GITHUB_OUTPUT
            echo "::warning::Cline CLI not available - workflow validation will be skipped"
          fi

      - name: ðŸ” Find Kestra flows
        id: flows
        run: |
          FLOWS=$(find kestra/flows -name "*.yaml" -o -name "*.yml" 2>/dev/null | head -10 || echo "")
          echo "flows=$FLOWS" >> $GITHUB_OUTPUT
          echo "has_flows=$([ -n "$FLOWS" ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: ðŸ›¡ï¸ Validate Kestra Workflows
        if: steps.flows.outputs.has_flows == 'true' && steps.cline-install-guardian.outputs.installed == 'true'
        continue-on-error: true
        run: |
          mkdir -p reports

          for FLOW in ${{ steps.flows.outputs.flows }}; do
            echo "Validating: $FLOW"

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # ACTUAL CLINE CLI USAGE - Validate Kestra YAML
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            cat "$FLOW" | timeout $CLINE_TIMEOUT cline -y "
            Validate this Kestra workflow YAML for:
            1. Valid YAML syntax and schema
            2. Security (no hardcoded secrets)
            3. Proper error handling
            4. AI prompt quality (if applicable)

            Output: âœ… VALID or âŒ INVALID with reasons
            " >> reports/workflow-guardian.md 2>&1 || true

            echo "---" >> reports/workflow-guardian.md
          done

          cat reports/workflow-guardian.md

      - name: ðŸ“ Create fallback report if Cline unavailable
        if: steps.flows.outputs.has_flows == 'true' && steps.cline-install-guardian.outputs.installed == 'false'
        run: |
          mkdir -p reports
          cat > reports/workflow-guardian.md << 'EOF'
          ## Workflow Validation Results

          âš ï¸ **Cline CLI not available** - automated workflow validation was skipped.

          Please validate Kestra workflows manually for:
          1. Valid YAML syntax and schema
          2. Security (no hardcoded secrets)
          3. Proper error handling
          4. AI prompt quality

          ---
          *Manual validation recommended*
          EOF

      - name: ðŸ“¤ Upload Workflow Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-guardian-report
          path: reports/
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Code Quality Review
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-review:
    name: ðŸ” AI Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: security-review

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ¤– Install Cline CLI
        id: cline-install-review
        run: |
          npm install -g cline || echo "::warning::Cline CLI installation failed"
          if command -v cline &> /dev/null; then
            echo "installed=true" >> $GITHUB_OUTPUT
            cline --version 2>/dev/null || echo "Cline installed (version unknown)"
          else
            echo "installed=false" >> $GITHUB_OUTPUT
            echo "::warning::Cline CLI not available - code review will be skipped"
          fi

      - name: ðŸ” Run Cline Code Review
        if: steps.cline-install-review.outputs.installed == 'true'
        continue-on-error: true
        run: |
          mkdir -p reports

          # Get diff
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          else
            DIFF=$(git diff HEAD~1...HEAD 2>/dev/null || git show HEAD)
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ACTUAL CLINE CLI USAGE - Code Review
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          echo "$DIFF" | timeout $CLINE_TIMEOUT cline -y "
          Review this code for:
          1. TypeScript best practices
          2. React/Next.js patterns
          3. Error handling
          4. Performance issues

          Output a brief review with:
          - âœ… What's good
          - âš ï¸ Issues found
          - ðŸ’¡ Suggestions
          " > reports/code-review.md 2>&1 || echo "Review completed"

          cat reports/code-review.md

      - name: ðŸ“ Create fallback report if Cline unavailable
        if: steps.cline-install-review.outputs.installed == 'false'
        run: |
          mkdir -p reports
          cat > reports/code-review.md << 'EOF'
          ## Code Review Results

          âš ï¸ **Cline CLI not available** - automated code review was skipped.

          Please review code manually for:
          1. TypeScript best practices
          2. React/Next.js patterns
          3. Error handling
          4. Performance issues

          ---
          *Manual code review recommended*
          EOF

      - name: ðŸ’¬ Post Code Review Comment
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let report = 'Code review completed.';

            try {
              report = fs.readFileSync('reports/code-review.md', 'utf8');
            } catch (e) {}

            const body = `## ðŸ” Cline AI Code Review

            ${report}

            ---
            *Powered by Cline CLI*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: ðŸ“¤ Upload Code Review
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: reports/
          retention-days: 30
