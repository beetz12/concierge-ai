# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Cline CLI Pre-Commit Hook
# AI-Powered Code Review and Security Scanning
# Part of the Infinity Build Award submission for AI Agents Assemble Hackathon
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo "ğŸ¤– Running Cline CLI pre-commit checks..."
echo ""

# Check if Cline is enabled (can be disabled with CLINE_ENABLED=false)
if [ "$CLINE_ENABLED" = "false" ]; then
    echo "â­ï¸  Cline checks skipped (CLINE_ENABLED=false)"
    exit 0
fi

# Check for YOLO mode (skip all checks)
if [ "$CLINE_YOLO" = "true" ]; then
    echo "âš¡ YOLO mode enabled - skipping Cline checks"
    exit 0
fi

# Get the project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# 1. Security Review (Critical - blocks commit if issues found)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”’ Step 1/3: Security Review"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -x "$PROJECT_ROOT/scripts/cline/security-review.sh" ]; then
    if ! "$PROJECT_ROOT/scripts/cline/security-review.sh" --staged; then
        echo ""
        echo "âŒ Security review failed! Please fix the issues above."
        echo "   To bypass: CLINE_YOLO=true git commit -m 'message'"
        exit 1
    fi
else
    echo "âš ï¸  Security review script not found, skipping..."
fi

echo ""

# 2. Workflow Guardian (For Kestra YAML files)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ›¡ï¸  Step 2/3: Workflow Guardian (Kestra)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check if any Kestra YAML files are staged (excluding deleted files, including renames)
STAGED_KESTRA=$(git diff --cached --name-only --diff-filter=ACMR | grep -E 'kestra/flows/.*\.(yaml|yml)$' || true)

if [ -n "$STAGED_KESTRA" ]; then
    if [ -x "$PROJECT_ROOT/scripts/cline/workflow-guardian.sh" ]; then
        for flow in $STAGED_KESTRA; do
            echo "Validating: $flow"
            if ! "$PROJECT_ROOT/scripts/cline/workflow-guardian.sh" "$PROJECT_ROOT/$flow"; then
                echo ""
                echo "âŒ Workflow validation failed! Please fix the issues above."
                echo "   To bypass: CLINE_YOLO=true git commit -m 'message'"
                exit 1
            fi
        done
    else
        echo "âš ï¸  Workflow guardian script not found, skipping..."
    fi
else
    echo "âœ… No Kestra workflows staged, skipping..."
fi

echo ""

# 3. Code Review (Informational - doesn't block)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Step 3/3: Code Review"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Only run code review if CLINE_FULL_REVIEW is set (optional, time-consuming)
if [ "$CLINE_FULL_REVIEW" = "true" ]; then
    if [ -x "$PROJECT_ROOT/scripts/cline/code-review.sh" ]; then
        "$PROJECT_ROOT/scripts/cline/code-review.sh" --staged || true
    fi
else
    echo "âœ… Quick mode - code review skipped"
    echo "   Set CLINE_FULL_REVIEW=true for full AI code review"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All Cline pre-commit checks passed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0
